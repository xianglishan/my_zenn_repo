---
title: "AzureVMã§Minecraftã‚µãƒ¼ãƒãƒ¼&Discord slash commandã§VMã®èµ·å‹•/åœæ­¢"
emoji: "ğŸ›µ"
type: "tech"
topics:
  - "azure"
  - "functions"
  - "azurevm"
published: true
published_at: "2021-09-29 20:43"
---

# ã¯ã˜ã‚ã«
ã¯ã˜ã‚ã¦ã“ã†ã„ã†ã®æ›¸ãã¾ã™ã€‚ã™ã”ãé©å½“ã§ã™ã€‚å‹é”ã«è¦‹ã›ã‚‹ç”¨ã‹ã¤å‚™å¿˜éŒ²ã§ã™ã€‚

# ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨
- ã‚µãƒ¼ãƒãƒ¬ã‚¹ãªã‚“ãŸã‚‰ã‚’ã•ã‚ã£ã¦ã¿ã‚‹
- Minecraftã‚’ãªã‚‹å®‰ã§å¿«é©ã«å‹é”ã¨éŠã¶
- AzureVMã¯å¾“é‡èª²é‡‘ã¨ã‚„ã‚‰ãªã®ã§Minecraftã—ãªã„æ™‚é–“ã¯ç¯€ç´„ã—ãŸã„
- Discordã§èµ·å‹•ã—ã¦ãã®ã¾ã¾ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«ã«ã„ã¦ã‚‚ã‚‰ã£ã¦ã€Œã‚ã„ã¤ã„ã‚‹ã˜ã‚ƒã‚“å‚åŠ ã—ã‚ˆã€ã£ã¦ãªã£ãŸã‚‰æ¥½ã—ãã†

# å®Ÿéš›ã«ã‚„ã£ãŸã“ã¨
- VMã«Minecraftã‚µãƒ¼ãƒå‹•ã‹ã™
- Discord botã«slash commandç™»éŒ²
- functionsã«botã®interactionå—ã‘ã¨ã‚‹é–¢æ•°(func1ã¨ã™ã‚‹)ç½®ã
- functionsã«func1ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ã‘å–ã£ã¦VMã‚’èµ·å‹•/åœæ­¢ã™ã‚‹é–¢æ•°ç½®ã

# å…¨ä½“åƒ
ä»¥ä¸‹å›³ã®æ„Ÿã˜ã§ã™
![](https://storage.googleapis.com/zenn-user-upload/62d9e2c5454fe895bd66cd1d.png)


# å®Ÿéš›ã«ã‚„ã£ãŸã“ã¨(è©³ç´°)
ä¸Šã®å®Ÿéš›ã«ã‚„ã£ãŸã“ã¨ã‚’å°ã•ã„ã‚¹ã‚³ãƒ¼ãƒ—ã§è§£èª¬ã€‚ã‚³ãƒ¼ãƒ‰æ®‹ã£ã¦ã‚‹ã‚„ã¤ã¯è¦‹ã›ã¾ã™ã€‚

## VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œã£ã¦Minecraftã‚µãƒ¼ãƒãƒ¼å‹•ã‹ã™
Azureã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦Azure Portalã¾ã§ã„ãã¾ã™ã€‚ãã‚“ã§VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¤ãã‚Šã¾ã™ã€‚è‡ªåˆ†ã¯ubuntu20ã§ä½œã‚Šã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/aab4dc9f53beafbf50dfe042.jpg)
useråã¨ã‹éµã¨ã‹ipaddressã¨ã‹ã¯ãƒ¡ãƒ¢å¸³ã«ã§ã‚‚æ›¸ã„ã¨ãã¾ã™ã€‚

ãªã‚“ã‹ã“ã“ã¾ã§ä¸å¯§ã«ã‚„ã‚‹å¿…è¦ãªã„æ°—ãŒã™ã‚‹ã®ã§çœç•¥ã—ã¤ã¤ã„ãã¾ã™ã€‚Minecraftã®ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ã™ã‚‹ç”¨ã®ãƒã‚·ãƒ³ã‚µã‚¤ã‚ºã¯èª¿ã¹ã¦ã‚„ã£ã¦
sshã®éµã¯ã„ã„æ„Ÿã˜ã«ä½œã£ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚Œã¾ã™ã€‚

ãã‚“ã§VMã«sshã—ã¾ã™ã€‚ã§ããªã„ã¨ãã¯ãŸã¶ã‚“éµã®ãƒ‘ã‚¹ãŒé–“é•ã£ã¦ã‚‹ã€‚.sshã«å…¥ã‚Œã¨ã“ã†ã­
```bash:bash
ssh -i {hoge_key.pemã®ãƒ‘ã‚¹} {username}@{ipaddress}
```

sshã§ããŸã‚‰ä¸€å¿œä½•ã§ã™ã‘ã©apt updateã—ã¦curlã¨ã‹vimã¨ã‹å…¥ã‚Œã¾ã™
sudoã„ã‚‰ã­ãƒ¼ã‚ˆã¨ã‹ã¯æ¥ãšã‹ã—ã„ã®ã§è¨€ã‚ãªã„ã§ãã ã•ã„ã€‚
```bash:bash
username@vmname:~$ sudo apt update -y
username@vmname:~$ sudo apt upgrade -y
username@vmname:~$ sudo apt install curl vimã€€-y
```

ãã‚“ã§Minecraftã®ãŸã‚ã«Javaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚ä»Šå›ã¯Minecraft17.1ã‚’ã‚„ã‚‹ã®ã§java16ã§ã™ã€‚ä»¥ä¸‹å‚ç…§
https://minecraft.mixjuice.info/2021/06/12/java16-ubuntu/

æ¬¡ã¯Minecraft-serverå…¥ã‚Œã¾ã™ã€‚
https://www.minecraft.net/ja-jp/download/server
ã“ã“ã®minecraft_server.1.17.1.jarã®ãƒªãƒ³ã‚¯urlã‚’ã‚³ãƒ”ãƒ¼ã—ã¨ãã¾ã—ã‚‡ã†ã€‚
ã‚“ã§é©å½“ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œã£ã¦ãã“ã«curlã—ã¾ã™ã€‚
```bash:bash
username@vmname:~$ mkdir mine
username@vmname:~$ cd mine
username@vmname:~$ curl -LO {ã•ã£ãã®url}
```

server.jarã¿ãŸã„ãªã®ãŒã‚ã‚‹ã®ã§å‹•ã‹ã—ã¨ãã¾ã—ã‚‡ã†ã€‚ä»Šå›ã¯systemdã«ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ã—ã¦OSèµ·å‹•æ™‚ã«è‡ªå‹•èµ·å‹•ã—ã¾ã™ã€‚ã“ã“ã¯ã‚ã‚“ã©ãã•ã„ã®ã§ä»¥ä¸‹å‚ç…§
https://qiita.com/nownabe/items/ca45bb4829d75460b31e

ãƒã‚¤ã‚¯ãƒ©ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®25565ãƒãƒ¼ãƒˆé–‹ã‘ã¾ã™ã€‚Azure Portalã‹ã‚‰vmã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã§ã€Œå—ä¿¡ãƒãƒ¼ãƒˆã®è¦å‰‡ã‚’è¿½åŠ ã™ã‚‹ã€ã¿ãŸã„ãªãƒœã‚¿ãƒ³ã§è¨­å®šã—ã¾ã™ã€‚
ã“ã“ã¾ã§ãã‚‹ã¨ãƒã‚¤ã‚¯ãƒ©ã§ãã¾ã™ã€‚

## Discord ã®botã¤ãã£ã¦ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²
ã“ã‚Œè¦‹ã¦ã‚„ã‚‹ã‚ˆ
https://zenn.dev/drumath2237/articles/112fd0bfa7ea4f836195

- Discord developer portalã§botã¤ãã£ã¦Discordã®ã‚µãƒ¼ãƒã«å…¥ã‚Œã¦ã‚ã’ã‚‹
- Discordã®apiä½¿ã£ã¦ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ã™ã‚‹
  - é©å½“ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¤ãã£ã¦ãã®ä¸­ã§npm initã—ã¦ã€npm install node-fetch requistã™ã‚‹
  - index.jsã¤ãã‚‹ã€‚ä»Šå›ã¯ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰
```js:index.js
import fetch from "node-fetch";

const appID = {botã®appID};
const guildID = {æ‹›å¾…ã—ãŸDiscordã‚µãƒ¼ãƒã®guildID};
const apiEndpoint = 
  `https://discord.com/api/v8/applications/${appID}/guilds/${guildID}/commands`;
const botToken = {botã®botToken};

const commandData = {
    name: "vmss",
    description: "command to start/stop vm",
    options: [
      {
        name: "action",
        description: "start/stop",
        type: 3,
        required: true,
        choices: [
          {
            name: "start",
            value: "start"
          },
          {
            name: "stop",
            value: "stop"
          },
          {
            name: "test",
            value: "test"
          },
        ],
      },
    ],
  };

  async function main() {

    const response = await fetch(apiEndpoint, {
    method: "post",
    body: JSON.stringify(commandData),
    headers: {
      Authorization: "Bot " + botToken,
      "Content-Type": "application/json",
    },
  });
  const json = await response.json();

  console.log(json);
}
main();
```
commandDataã®ä¸­èº«ãŒç™»éŒ²ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
vmssã£ã¦åå‰ã®ã€å¼•æ•°(action:start/stop/test)ä¸€ã¤å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã ã‚ˆã£ã¦

  - ãã‚“ã§bashã§node index.jsã¨ã—ã¦å®Ÿè¡Œ
  - Discordã®apiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«commandã®ä¸­èº«ã‚’jsonã§http req (post)ã—ã¦ç™»éŒ²
  - idã¨ã‹ãŒjsonã§å¸°ã£ã¦ããŸã‚‰(http res)å®Œäº†

ã“ã‚“ãªæ„Ÿã˜ã§tabã§è‡ªå‹•è£œå®Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/25b415ff38973b5d12eba38e.jpg)
ä¸­èº«ãªã„ã‹ã‚‰é€ä¿¡ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

ä¸€å¿œgithubç½®ã„ã¨ã
https://github.com/xianglishan/discbotcommands

## Discord bot ã‹ã‚‰interactionã‚’å—ã‘ã¨ã‚‹é–¢æ•°ã‚’ã¤ãã£ã¦functionsã«ãƒ‡ãƒ—ãƒ­ã‚¤
Azure Portalã‹ã‚‰é–¢æ•°ã‚¢ãƒ—ãƒªã‚’ã¤ãã‚‹ã€‚ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯nodejs14LTSã§ãƒ—ãƒ©ãƒ³ã¯é‡é‡èª²é‡‘ã®ã‚„ã¤
vscodeã«å…¬å¼æ‹¡å¼µãŒã‚ã‚‹ã®ã§ãã‚Œã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã¤ãã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã§ãã‚‹ã€‚ä»¥ä¸‹å‚ç…§
https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-develop-vs-code?tabs=csharp
ãƒˆãƒªã‚¬ãƒ¼ã¯http, è¨€èªã¯ typescript,é–¢æ•°åã¯é©å½“ã«æ±ºã‚ã¦å‡ºæ¥ä¸ŠãŒã£ãŸã‚‰ã€å¿…è¦ãªã‚„ã¤ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash:bash
$ npm install
$ npm install discord-interactions express @types/node
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/é–¢æ•°å/index.tsã«ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰
```ts:index.ts
import { AzureFunction, Context, HttpRequest } from "@azure/functions";
import {
  InteractionType,
  InteractionResponseType,
  verifyKey,
} from "discord-interactions";
//import fetch from "node-fetch";
import axios from "axios";

const CLIENT_PUBLIC_KEY = process.env.CLIENT_PUBLIC_KEY;
const STARTURL = process.env.STARTURL;
const STOPURL = process.env.STOPURL;

const httpTrigger: AzureFunction = async function (
  context: Context,
  req: HttpRequest
): Promise<void> {
  const sig = req.headers["x-signature-ed25519"];
  const time = req.headers["x-signature-timestamp"];
  const isValid = await verifyKey(req.rawBody, sig, time, CLIENT_PUBLIC_KEY);

  if (!isValid) {
    context.res = {
      status: 401,
      Headers: {},
      body: "",
    };
    return;
  }

  const interaction = req.body;
  if (interaction && interaction.type === InteractionType.APPLICATION_COMMAND) {
    const action = req.body.data.options[0].value;
    const username = req.body.member.user.username;

    if (action == "start") {
      axios.get(STARTURL);
      //fetch(STARTURL);

      context.res = {
        status: 200,
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
          data: {
            content: `hi ${username}, server ${action}. connect minecraft server few minutes later.`,
          },
        }),
      };

    } else if (action == "stop") {
      axios.get(STOPURL);
      //fetch(STOPURL);
      
      context.res = {
        status: 200,
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
          data: {
            content: `server ${action} in few minutes.`,
          },
        }),
      };

    } else if(action == "test"){
      context.res = {
        status: 200,
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
          data: {
            content: `${action}, by ${username}`,
          },
        }),
      };
    }

  } else {
    context.res = {
      body: JSON.stringify({
        type: InteractionResponseType.PONG,
      }),
    };
  }
};

export default httpTrigger;
```
ã“ã“ã§STARTURLã¨STOPURLã¯æ¬¡ã®functionã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹(CLIENT_PUBLIC_KEYã‚‚ã§ã™)ã€‚ç’°å¢ƒå¤‰æ•°ã¯Azure Portalã®é–¢æ•°ã‚¢ãƒ—ãƒª-ãƒ¡ãƒ‹ãƒ¥-è¨­å®š-æ§‹æˆã®ã¨ã“ã‚ã§æ§‹æˆã‚’è¿½åŠ ã¨ã‹ã£ã¦ã‚„ã‚‹ã¨ã§ãã‚‹ã€‚

 action: startãªã‚‰STARTURLw=ã«http req (get)ã™ã‚‹æ„Ÿã˜ã€‚ãã‚Œã§æ¬¡ã®functionã‚’å‘¼ã³å‡ºã™ã€‚resã‚’å¾…ã£ã¦ã‚‹ã¨æ™‚é–“æ›ã‹ã£ã¦botå´ãŒå‹æ‰‹ã«ã‚¨ãƒ©ãƒ¼åãã‹ã‚‰awaitã—ãªã„ã§æŠ•ã’ã£ã±ãªã—

ã“ã„ã¤ã‚’vscodeã®ã•ã£ãã„ã‚ŒãŸæ‹¡å¼µã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒœã‚¿ãƒ³ã§ã§ãã‚‹ã‚ˆã€‚

ãã‚“ã§ã“ã®é–¢æ•°ã®urlã‚’Discord developer portalã‹ã‚‰botã‚¢ãƒ—ãƒªã®interaction end point ã«ç™»éŒ²ã™ã‚‹ã€‚

ã“ã‚Œã§discordã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã¨å¿œç­”ãŒå¸°ã£ã¦ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

ä¸€å¿œgithubç½®ã„ã¨ã
https://github.com/xianglishan/discbotInteraction2azurefunction

## http req ã‹ã‚‰VMã‚’èµ·å‹•/åœæ­¢ã™ã‚‹function
æ¬¡ã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯powershellã§é–¢æ•°ã‚¢ãƒ—ãƒªã¤ãã‚Šã¾ã™ã€‚

ã“ã“ã¯è¨­å®šã‚„ã‚„ã“ã—ãã¦é›£ã—ã„ã®ã§githubãŠã„ã¨ãã¾ã™ã€‚

ã¨ã‚Šã‚ãˆãšVMã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦‹ã¦ãã‚‹å‡¦ç†ã¨ã‹èµ·å‹•ã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã‚‹å‡¦ç†ã¨ã‹ã¡ã‚‡ã£ã¨å¾…ã¡æ™‚é–“é•·ã„æ„Ÿã˜ãªã®ã§ã“ã“ã«ã„ããªã‚Šbotã‹ã‚‰interactionãªã’ã‚‹ã¨å¾…ã¡ãŒé•·ãã¦ã‚¨ãƒ©ãƒ¼åã‹ã‚Œã‚‹ã€‚

https://github.com/xianglishan/azureFunctions2VM

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã“ã®é–¢æ•°ã®ãƒ—ãƒ­ã‚­ã‚·urlã‚’ä¸€ã¤ç›®ã®é–¢æ•°ã‚¢ãƒ—ãƒªã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ãŸã‚Šã—ã¦å…¨éƒ¨ã†ã¾ãè¡Œãã¨Discordã§/vmss action:startã£ã¦æ‰“ã¤ã¨30ç§’å¾Œãã‚‰ã„ã«ã¯ãƒã‚¤ã‚¯ãƒ©ã§ãã‚‹

## å®Œæˆ
ã“ã‚Œã§Discordã§ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã¨VMãŒèµ·å‹•ã§ãã¦ã€systemdã§å‹•ã„ã¦ã‚‹Minecraft serverã§éŠã¹ã‚‹ãœ
Azureã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¤ãã£ã¦æ¸¡ã—ã¦ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰VMã®çŠ¶æ…‹ç¢ºèªã—ã¦èµ·å‹•ã™ã‚‹ã¿ãŸã„ãªã“ã¨ã‚‚ãªã„
![](https://storage.googleapis.com/zenn-user-upload/653ee79237826abbf1e4e0c4.jpg)

![](https://storage.googleapis.com/zenn-user-upload/ba9e951baf9da6186204a4b9.jpg)

ã§ã‚‚ãªã‚“ã‹ã‚¨ãƒ©ãƒ¼ã¯ã„ã¦ãã‚‹

## ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚‰ã—ã„
ã“ã‚Œã¿ã‚‹ã¨ãªã‚“ã¨ãªãã‚ã‹ã‚‹ã€‚é–¢æ•°ã®ãƒ›ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã‚’é‡é‡èª²é‡‘ãƒ—ãƒ©ãƒ³ã‹ã‚‰ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãªã‚„ã¤ã«ã™ã‚‹ã“ã¨ã§è§£æ±ºã™ã‚‹ã‚‰ã—ã„
https://blog.alea12.net/serverless-functions

å®Ÿéš›ã«æœ€åˆã®2,3ç™ºã¯ã‚¨ãƒ©ãƒ¼åã
![](https://storage.googleapis.com/zenn-user-upload/f66ee286474356d1c0454a48.jpg)

VMã‚‚2ã¤ã®é–¢æ•°ã‚‚å¯ã¦ã‚‹çŠ¶æ…‹ã‹ã‚‰ä¸€äººã¥ã¤ãŸãŸãèµ·ã“ã—ã¦ã‚‹æ„Ÿã˜ï¼Ÿãªã‚“ã¨ã‹ã—ãŸã„

## ã•ã„ã”ã«

ã‚ã¡ã‚ƒãã¡ã‚ƒèµ°ã‚Šæ›¸ããªã®ã§ã‚ã‹ã‚Šãšã‚‰ã„ã¨æ€ã„ã¾ã™ã€‚æ™‚é–“ãŒã‚ã‚‹ã¨ãã«è¿½è¨˜ã—ã¾ã™ã€‚

ã‚‚ã—åŒã˜ã‚ˆã†ãªã“ã¨ã—ã‚ˆã†ã¨ã—ã¦ã„ã¦ã“ã“æ›¸ã„ã¦ï¼ã£ã¦ã®ãŒã‚ã‚Œã°ãªã‚‹ã¹ãå¯¾å¿œã—ã¾ã™ã€‚