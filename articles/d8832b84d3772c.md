---
title: "ec2ã§ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒ & ec2èµ·å‹•åœæ­¢ã®Discord slash commandã‚’lambdaã«ãƒ‡ãƒ—ãƒ­ã‚¤"
emoji: "ğŸ¦„"
type: "tech"
topics:
  - "lambda"
  - "ec2"
  - "discord"
  - "minecraft"
published: true
published_at: "2021-12-18 04:47"
---

## ã¯ã˜ã‚ã«
ä»Šå›ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’awsã§ä½œã‚Šç›´ã—ãŸã‚‚ã®ã§ã™ã€‚å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚ã‚ã¡ã‚ƒãã¡ã‚ƒçœç•¥ã—ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

https://zenn.dev/xianglishan/articles/45cb2271c78c3e

## ã‚„ã‚ŠãŸã„ã“ã¨
- å‹é”ã¨ã„ã¤ã§ã‚‚ã ã‚Œã§ã‚‚éŠã¹ã‚‹ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒã‚’ç”¨æ„ã—ãŸã„
- æ™®æ®µã¯ã»ã¨ã‚“ã©ã‚„ã‚‰ãªã„ã®ã§éç¨¼åƒæ™‚ã®ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆãŸã„
- ã©ã†ã›ãªã‚‰Discordã§ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰ã ã‚Œã§ã‚‚ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³/ã‚ªãƒ•ã§ãã‚‹
	â†’ãã®ã¾ã¾ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆã§ã€Œã‚ã„ã¤ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã˜ã‚ƒã‚“ãŠã‚Œã‚‚ã‚„ã‚ã€ã¿ãŸã„ã«ãªã£ãŸã‚‰ã†ã‚Œã—ã„

## ã‚„ã£ãŸã“ã¨
ã–ã£ãã‚Šã„ã†ã¨ä»¥ä¸‹å›³

å‰å›ã¨æ¯”ã¹ã‚‹ã¨AzureVMã‚’ec2ã«ã€Azure functionã‚’lambdaã«å¤‰ãˆã¦ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/244442829ea3-20211218.png)
- ec2ã§ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒ
- Discord slash commandã§èµ·å‹•/åœæ­¢ã‚’lambdaã«http req
- lambdaã‹ã‚‰ec2èµ·å‹•/åœæ­¢

æœ€å®‰ã‚’æ±‚ã‚ã‚‹ã¨AMIä¿å­˜ã—ã¦ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº† & AMIã‹ã‚‰èµ·å‹•ã€‚ã§ã‚‚ä»Šå›ã¯ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åœæ­¢/ãã®ã¾ã¾èµ·å‹•ã—ã¦ã¾ã™ã€‚

ãƒ‡ã‚£ã‚¹ã‚¯ãã‚“ãªã«ä½¿ã‚ãªã„ã®ã§ã¾ã£ãŸãä½¿ã‚ãªã„æœˆã§100å††ãã‚‰ã„ãªã®ã§ã¾ã‚ãˆãˆã‚„ã‚ã£ã¦æ„Ÿã˜ã§é‹ç”¨ã—ã¦ã¾ã™ã€‚

ãã®ã†ã¡ä¸Šè¨˜AMIä½¿ã†æ„Ÿã˜ã«ã—ãŸã„ã¨æ€ã„ã¤ã¤ã‚„ã£ã¦ãªã„ã§ã™ã€‚

## ã‚„ã£ãŸã“ã¨è©³ç´°
### ec2ã§ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒ
é©å½“ã«ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¦ã€javaã¨minecraft serverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€systemdã§è‡ªå‹•èµ·å‹•è¨­å®šã€‚

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¯4vcpu, ãƒ¡ãƒ¢ãƒª4Gbãã‚‰ã„ã‚ã‚Œã°å¿«é©ã«éŠã¹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã®è¾ºè¦‹ã¾ã—ãŸã€‚
https://minecraft.server-memo.net/minecraftserver-3/
https://www.minecraft.net/ja-jp/download/server

### Discord slash command ç™»éŒ²
Discord developer portalã§Discordã®botä½œã£ã¦slash commandç™»éŒ²ã€‚

ã“ã®è¾ºè¦‹ã¦ã‚„ã‚Šã¾ã—ãŸã€‚
https://zenn.dev/drumath2237/articles/112fd0bfa7ea4f836195
https://discordpy.readthedocs.io/ja/latest/api.html

TypeScriptã§ã‚„ã£ãŸã‘ã©pythonã¨ã‹ã§ã‚‚ã§ãã‚‹ã‚ˆ

ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜
```TypeScript:index.js
import fetch from "node-fetch";

const appID = {botã®appID};
const guildID = {æ‹›å¾…ã—ãŸDiscordã‚µãƒ¼ãƒã®guildID};
const apiEndpoint = 
  `https://discord.com/api/v8/applications/${appID}/guilds/${guildID}/commands`;
const botToken = {botã®botToken};

const commandData = {
    name: "vmss",
    description: "command to start/stop vm",
    options: [
      {
        name: "action",
        description: "start/stop",
        type: 3,
        required: true,
        choices: [
          {
            name: "start",
            value: "start"
          },
          {
            name: "stop",
            value: "stop"
          },
          {
            name: "test",
            value: "test"
          },
        ],
      },
    ],
  };

  async function main() {

    const response = await fetch(apiEndpoint, {
    method: "post",
    body: JSON.stringify(commandData),
    headers: {
      Authorization: "Bot " + botToken,
      "Content-Type": "application/json",
    },
  });
  const json = await response.json();

  console.log(json);
}
main();
```
ä¸€å¿œgithubç½®ã„ã¨ãã¾ã™
https://github.com/xianglishan/discbotcommands

### lambdaé–¢æ•°
discord botã‹ã‚‰http reqå¾…ã¡å—ã‘ã¦ec2èµ·å‹•/åœæ­¢ã™ã‚‹lambdaé–¢æ•°ã¤ãã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’è¦‹ã¦ã‚„ã‚Šã¾ã—ãŸã€‚
https://note.sarisia.cc/entry/discord-slash-commands/

ã“ã‚Œã¯python3ã§ã€
ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹
```python:lambda_function.py
import json
import os
import boto3

from botocore.vendored import requests
from nacl.signing import VerifyKey

DISCORD_TOKEN = '{discord bot token}'
APPLICATION_ID = '{discord app id}'
APPLICATION_PUBLIC_KEY = '{app pub key}'
COMMAND_GUILD_ID = '{guild id}'

verify_key = VerifyKey(bytes.fromhex(APPLICATION_PUBLIC_KEY))

def verify(signature: str, timestamp: str, body: str) -> bool:
    try:
        verify_key.verify(f"{timestamp}{body}".encode(), bytes.fromhex(signature))
    except Exception as e:
        print(f"failed to verify request: {e}")
        return False

    return True

def lambda_handler(event: dict, context: dict):
    # API Gateway has weird case conversion, so we need to make them lowercase.
    # See https://github.com/aws/aws-sam-cli/issues/1860
    headers: dict = { k.lower(): v for k, v in event['headers'].items() }
    rawBody: str = event['body']

    # validate request
    signature = headers.get('x-signature-ed25519')
    timestamp = headers.get('x-signature-timestamp')
    if not verify(signature, timestamp, rawBody):
        return {
            "cookies": [],
            "isBase64Encoded": False,
            "statusCode": 401,
            "headers": {},
            "body": ""
        }
    
    req: dict = json.loads(rawBody)
    if req['type'] == 1: # InteractionType.Ping
        return {
            "type": 1 # InteractionResponseType.Pong
        }
    elif req['type'] == 2: # InteractionType.ApplicationCommand
        # command options list -> dict
        # opts = {v['name']: v['value'] for v in req['data']['options']} if 'options' in req['data'] else {}
        action = req['data']['options'][0]['value']
        username = req['member']['user']['username']

        if action == 'start':
            boto3.client('lambda').invoke(
                FunctionName='startmcs',
                InvocationType='Event'
            )
            text = 'hi ' + username + ", server will start in a minute."
            
        if action == 'stop':
            boto3.client('lambda').invoke(
                FunctionName='stopmcs',
                InvocationType='Event'
            )
            text = "server will stop."
            
        if action == 'test':
            status = boto3.client('ec2').describe_instances(
                Filters=[{'Name':'instance-id', 'Values':['{å–å¾—ã—ãŸã„EC2ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID}']}]
            )["Reservations"][0]["Instances"][0]['State']['Name'] 
            text = 'server is ' + status + '!!!!'

        return {
            "type": 4, # InteractionResponseType.ChannelMessageWithSource
            "data": {
                "content": text
            }
        }
```
ä»Šå›ã¯lambdaé–¢æ•°â†’lambdaé–¢æ•°ã®å‘¼ã³å‡ºã—ã‚’ã‚„ã£ã¦ã¿ãŸãã¦start/stopã®å ´åˆã¯åˆ¥é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

å‘¼ã³å‡ºã—å…ˆã®é–¢æ•°ã¯ä»¥ä¸‹å‚ç…§
https://aws.amazon.com/jp/premiumsupport/knowledge-center/start-stop-lambda-cloudwatch/

testã®æ™‚ã¯ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ã‚’boto3ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã§å®Œæˆ

ä»¥ä¸‹ç”»åƒã®æ„Ÿã˜ã§ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã§ec2èµ·å‹•ã—ã¦minecraftã§ãã‚‹
![](https://storage.googleapis.com/zenn-user-upload/ac12b420e3c1-20211218.png)
![](https://storage.googleapis.com/zenn-user-upload/e144101ff2ea-20211218.png)


## ã•ã„ã”ã«
ãƒãƒã£ãŸç‚¹
- systemd
- Discordã®APIã®ä»•æ§˜ã¨ã‹
- lambdaã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®import(zipã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)

ãã®ã†ã¡ã ã‘ã©ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•/åœæ­¢â†’ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®AMIä¿å­˜ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº†/AMIã‹ã‚‰ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ã«å¤‰ãˆãŸã„ã€‚